(function(e){function i(n,r){var i=n.offset();n.addClass("ft-widget").css({top:0,left:0,position:"static"});n.wrap('<div class="ft-container"></div>');var u=n.parent(),a="";a+='<div class="ft-controls">';a+='<div class="ft-rotator"></div>';a+='<div class="ft-scaler ft-scaler-top ft-scaler-left ft-scaler-tl"></div>';a+='<div class="ft-scaler ft-scaler-top ft-scaler-right ft-scaler-tr"></div>';a+='<div class="ft-scaler ft-scaler-bottom ft-scaler-right ft-scaler-br"></div>';a+='<div class="ft-scaler ft-scaler-bottom ft-scaler-left ft-scaler-bl"></div>';a+='<div class="ft-scaler ft-scaler-top ft-scaler-center ft-scaler-tc"></div>';a+='<div class="ft-scaler ft-scaler-bottom ft-scaler-center ft-scaler-bc"></div>';a+='<div class="ft-scaler ft-scaler-mid ft-scaler-left ft-scaler-ml"></div>';a+='<div class="ft-scaler ft-scaler-mid ft-scaler-right ft-scaler-mr"></div>';a+="</div>";var l={x:i.left,y:i.top,scalex:1,scaley:1,angle:0,maintainAspectRatio:!1,scaleLimit:.1,"rot-origin":"50% 50%",_p:{divs:{},prev:{},wid:n.width(),hgt:n.height(),rad:r&&r.angle?r.angle*t:0,controls:!0,dom:n[0]}};u.append(a);var c=l._p.divs.controls=u.find(".ft-controls"),h=l._p.divs.rotator=u.find(".ft-rotator"),p=l._p.divs.tl=u.find(".ft-scaler-tl"),d=l._p.divs.tr=u.find(".ft-scaler-tr"),v=l._p.divs.br=u.find(".ft-scaler-br"),y=l._p.divs.bl=u.find(".ft-scaler-bl"),b=l._p.divs.tc=u.find(".ft-scaler-tc"),w=l._p.divs.bc=u.find(".ft-scaler-bc"),S=l._p.divs.ml=u.find(".ft-scaler-ml"),x=l._p.divs.mr=u.find(".ft-scaler-mr");l._p.divs.container=u;l._p.cwid=c.width();l._p.chgt=c.height();n.data("freetrans",l);r&&m(n.data("freetrans"),r);u.bind("mousedown.freetrans",s(o(function(t){var r=n.data("freetrans"),i=Point(t.pageX,t.pageY),s=o(function(e){r.x+=e.pageX-i.x;r.y+=e.pageY-i.y;i=Point(e.pageX,e.pageY);E(n,r)}),u=function(t){e(document).unbind("mousemove.freetrans",s);e(document).unbind("mouseup.freetrans",u)};e(document).bind("mousemove.freetrans",s);e(document).bind("mouseup.freetrans",u)})));h.bind("mousedown.freetrans",s(o(function(r){r.stopPropagation();var i=n.data("freetrans"),s=f(i._p.divs.controls).center,u=Math.atan2(r.pageY-s.y,r.pageX-s.x)*180/Math.PI;rot=Number(i.angle);var a=o(function(e){var r=Math.atan2(e.pageY-s.y,e.pageX-s.x)*180/Math.PI,o=rot+r-u;e.shiftKey&&(o=(o/15>>0)*15);i.angle=o;i._p.rad=o*t;E(n,i)}),l=function(t){e(document).unbind("mousemove.freetrans",a);e(document).unbind("mouseup.freetrans",l)};e(document).bind("mousemove.freetrans",a);e(document).bind("mouseup.freetrans",l)})));u.find(".ft-scaler").bind("mousedown.freetrans",s(o(function(t){t.stopPropagation();var r=l.scaleLimit,i,s,a,f,h,m,T=n.data("freetrans"),N=e(t.target),C=c.width(),k=c.height(),L=C/k,A=C*1/T.scalex,O=k*1/T.scaley,M=p.offset(),_=d.offset(),D=v.offset(),P=y.offset(),H=b.offset(),B=w.offset(),j=S.offset(),F=x.offset(),I=Math.atan2(_.top-M.top,_.left-M.left),q=Math.sin(I),R=Math.cos(I);a=function(e,t){T.x+=e.left-t.left;T.y+=e.top-t.top;E(n,T)};if(N.is(v)||N.is(x)){i=M;h=N.is(v);s=function(e){e.x-=i.left;e.y-=i.top;e=g(e,q,R);T.scalex=e.x/A>r?e.x/A:r;h&&(T.scaley=e.y/O>r?e.y/O:r)};positionMe=function(){a(i,u.find(".ft-scaler-tl").offset())}}else if(N.is(p)||N.is(S)){i=D;h=N.is(p);s=function(e){e.x=i.left-e.x;e.y=i.top-e.y;e=g(e,q,R);T.scalex=e.x/A>r?e.x/A:r;h&&(T.scaley=e.y/O>r?e.y/O:r)};positionMe=function(){a(i,u.find(".ft-scaler-br").offset())}}else if(N.is(d)||N.is(b)){i=P;m=N.is(d);q=Math.sin(-I);R=Math.cos(-I);s=function(e){e.x-=i.left;e.y=i.top-e.y;e=g(e,q,R);m&&(T.scalex=e.x/A>r?e.x/A:r);T.scaley=e.y/O>r?e.y/O:r};positionMe=function(){a(i,u.find(".ft-scaler-bl").offset())}}else if(N.is(y)||N.is(w)){i=_;m=N.is(y);q=Math.sin(-I);R=Math.cos(-I);s=function(e){e.x=i.left-e.x;e.y-=i.top;e=g(e,q,R);m&&(T.scalex=e.x/A>r?e.x/A:r);T.scaley=e.y/O>r?e.y/O:r};positionMe=function(){a(i,u.find(".ft-scaler-tr").offset())}}var U=o(function(e){if(s){s(Point(e.pageX,e.pageY));if(e.shiftKey||l.maintainAspectRatio)if(!N.hasClass("ft-scaler-center")){T.scaley=A*T.scalex*(1/L)/O;N.is(S)?positionMe=function(){a(F,u.find(".ft-scaler-mr").offset())}:N.is(x)&&(positionMe=function(){a(j,u.find(".ft-scaler-ml").offset())})}else{T.scalex=O*T.scaley*L/A;N.is(b)?positionMe=function(){a(B,u.find(".ft-scaler-bc").offset())}:positionMe=function(){a(H,u.find(".ft-scaler-tc").offset())}}T._p.cwid=T._p.wid*T.scalex;T._p.chgt=T._p.hgt*T.scaley;E(n,T);positionMe&&positionMe()}}),z=function(t){E(n,T);e(document).unbind("mousemove.freetrans",U);e(document).unbind("mouseup.freetrans",z)};e(document).bind("mousemove.freetrans",U);e(document).bind("mouseup.freetrans",z)})));n.css({position:"absolute"})}function s(e){return function(t){if(t.which===1)return e(t)}}function o(e){return function(t){t.preventDefault();t.stopImmediatePropagation();return e(t)}}function u(t){var n=t.data("freetrans");e(document).unbind(".freetrans");for(var r in n._p.divs)n._p.divs[r].unbind(".freetrans");n._p.divs.container.replaceWith(t);t.removeData("freetrans")}function a(e){var t=e.data("freetrans"),n={angle:t.angle,maintainAspectRatio:t.maintainAspectRatio,"rot-origin":t["rot-origin"],scaleLimit:t.scaleLimit,scalex:t.scalex,scaley:t.scaley,x:t.x,y:t.y};return n}function f(t){var n={};t.find(".ft-scaler").each(function(t){var r=e(this),i=r.offset(),s=r.width()/2,o=r.height()/2;if(t==0){n.xmin=i.left+s;n.xmax=i.left+s;n.ymin=i.top+o;n.ymax=i.top+o}else{n.xmin=Math.min(n.xmin,i.left+s);n.xmax=Math.max(n.xmax,i.left+s);n.ymin=Math.min(n.ymin,i.top+o);n.ymax=Math.max(n.ymax,i.top+o)}n.width=n.xmax-n.xmin;n.height=n.ymax-n.ymin;n.center=Point(n.xmin+n.width/2,n.ymin+n.height/2)});return n}function c(e){var t;if(n){t=n+e.substr(0,1).toUpperCase()+e.substr(1);return function(n,r){n.style[t]=n.style[e]=r}}return function(t,n){t.style[e]=n}}function v(e,t){var n=e.data("freetrans"),r=n._p.controls;if(typeof t=="undefined")t=!r;else if(t==n._p.controls)return;n._p.divs.controls.css({visibility:t?"visible":"hidden"});n._p.controls=t;t&&E(e,n)}function m(n,r){delete r._p;n=e.extend(n,r);if(r.matrix){var i=r.matrix.match(/\.?\d+/g),s=w(Matrix(i[0],i[1],i[2],i[3],i[4],i[5]));n._p.rad=s.rad;n._p.cwid=n._p.wid*s.sx;n._p.chgt=n._p.hgt*s.sy;n.x=s.tx;n.y=s.ty;n.scalex=s.sx;n.scaley=s.sy;n.angle=s.rad/t}else{r.hasOwnProperty("angle")&&!isNaN(r.angle)&&(n._p.rad=n.angle*t);r.hasOwnProperty("scalex")&&!isNaN(r.scalex)&&(n._p.cwid=n._p.wid*r.scalex);r.hasOwnProperty("scaley")&&!isNaN(r.scaley)&&(n._p.chgt=n._p.hgt*r.scaley)}}function g(e,t,n){return Point(e.x*n+e.y*t,e.y*n-e.x*t)}function y(e){var t=e.data("freetrans"),n=t["rot-origin"],r=Point(0,0);if(!n||n=="50% 50%")return r;var i=n.split(" "),s=i.length;if(!s)return r;var o=parseInt(i[0]),u=i[0].indexOf("%")>-1,a=t._p.divs.controls,f=t._p.cwid;r.x=(u?o/100*f:o)-f/2;if(s==1)r.y=r.x;else{o=i[1];u=o.indexOf("%")>-1;o=parseInt(o);f=t._p.chgt;r.y=(u?o/100*f:o)-f/2}return r}function b(e){String(e.a).length>8&&(e.a=Number(e.a).toFixed(8));String(e.b).length>8&&(e.b=Number(e.b).toFixed(8));String(e.c).length>8&&(e.c=Number(e.c).toFixed(8));String(e.d).length>8&&(e.d=Number(e.d).toFixed(8));String(e.tx).length>8&&(e.tx=Number(e.tx).toFixed(8));String(e.ty).length>8&&(e.ty=Number(e.ty).toFixed(8));return"matrix("+e.a+","+e.b+","+e.c+","+e.d+","+e.tx+","+e.ty+")"}function w(e){var t={tx:Number(e.tx),ty:Number(e.ty),rad:Math.atan2(Number(e.b),Number(e.a)),sx:Math.sqrt(e.a*e.a+e.b*e.b),sy:Math.sqrt(e.c*e.c+e.d*e.d)};return t}function E(e,t){if(!t)return;var n,r;if(t._p.controls){r=t._p.divs.controls[0];r.style.top=t.y+t._p.hgt*(1-t.scaley)+"px";r.style.left=t.x+t._p.wid*(1-t.scalex)+"px";r.style.width=t._p.cwid+"px";r.style.height=t._p.chgt+"px";if(t._p.prev.angle!=t.angle||t._p.prev.controls!=t._p.controls){n=b(Matrix().rotate(t._p.rad));h(r,n);p(r,t["rot-origin"]);n=b(Matrix().rotate(-t._p.rad));h(t._p.divs.rotator[0],n);p(t._p.divs.rotator[0],t["rot-origin"]);t._p.prev.controls=t._p.controls}r=t._p.divs.rotator[0];r.style.top="-20px";r.style.left=t._p.cwid+4+"px";h(r,n);p(r,t["rot-origin"])}r=t._p.dom;var i=t.y+t._p.hgt*(1-t.scaley)/2>>0;l=t.x+t._p.wid*(1-t.scalex)/2>>0;i!=t._p.prev.top&&(r.style.top=i+"px");l!=t._p.prev.left&&(r.style.left=l+"px");t._p.prev.top=i;t._p.prev.left=l;if(t.angle!=t._p.prev.angle||t.scalex!=1||t.scaley!=1){var s=Matrix();if(t.angle){s=s.rotate(t._p.rad,y(e));t._p.prev.angle=t.angle}if(t.scalex!=1||t.scaley!=1)s=s.scale(t.scalex,t.scaley);n=b(s)}else n="matrix(1,0,0,1,0,0);";if(t._p.prev.mat!=n){h(r,n);t._p.prev.mat=n}}var t=Math.PI/180,n=function(){var t,n={webkit:"Webkit",gecko:"Moz",trident:"ms",presto:"O"};e.each(n,function(e,n){if((new RegExp(e+"/","i")).test(navigator.userAgent)){t=n;return!1}});return t}(),r={init:function(t){return this.each(function(){var n=e(this),r=n.data("freetrans");if(r){m(r,t);E(n,r)}else{i(n,t);E(n,n.data("freetrans"))}})},destroy:function(){return this.each(function(){u(e(this))})},getOptions:function(){this.length>1&&e.error("Method jQuery.freetrans.getOptions can only be called on single selectors!");return a(e(this))},getBounds:function(){this.length>1&&e.error("Method jQuery.freetrans.getBounds can only be called on single selectors!");return f(this.data("freetrans")._p.divs.controls)},controls:function(t){return this.each(function(){var n=e(this),r=n.data("freetrans");r||i(n);v(n,t)})}};e.fn.freetrans=function(t){if(r[t])return r[t].apply(this,Array.prototype.slice.call(arguments,1));if(typeof t=="object"||!t)return r.init.apply(this,arguments);e.error("Method "+t+" does not exist on jQuery.freetrans");return!1};var h=c("transform"),p=c("transformOrigin"),d=c("transformStyle")})(jQuery);